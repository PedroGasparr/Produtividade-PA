<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processo de Shipment - Sistema PA</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }
        
        .sidebar-logo {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }
        
        .sidebar-menu li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .sidebar-menu li a:hover {
            background-color: #34495e;
        }
        
        .sidebar-menu li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .sidebar-menu li.active a {
            background-color: #3498db;
            color: white;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            background-color: #ecf0f1;
        }
        
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .primary-btn {
            background-color: #3498db;
            color: white;
        }
        
        .primary-btn:hover {
            background-color: #2980b9;
        }
        
        .secondary-btn {
            background-color: #95a5a6;
            color: white;
        }
        
        .secondary-btn:hover {
            background-color: #7f8c8d;
        }
        
        .success-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .success-btn:hover {
            background-color: #27ae60;
        }
        
        .danger-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .danger-btn:hover {
            background-color: #c0392b;
        }
        
        .warning-btn {
            background-color: #f39c12;
            color: white;
        }
        
        .warning-btn:hover {
            background-color: #d35400;
        }
        
        .process-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .process-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .process-card-header {
            padding: 15px;
            background-color: #3498db;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .process-card-title {
            font-size: 16px;
            font-weight: 500;
        }
        
        .process-card-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .process-card-status.pending {
            background-color: #f39c12;
        }
        
        .process-card-status.in_progress {
            background-color: #3498db;
        }
        
        .process-card-status.completed {
            background-color: #2ecc71;
        }
        
        .process-card-body {
            padding: 15px;
        }
        
        .process-card-info {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .process-card-info strong {
            font-weight: 500;
        }
        
        .timer-display {
            margin: 10px 0;
            font-size: 14px;
        }
        
        .step-title {
            font-weight: 500;
            margin: 10px 0;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .process-card-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .qr-scanner-container {
            margin: 15px 0;
            text-align: center;
        }
        
        .qr-scanner-container video {
            width: 100%;
            max-width: 300px;
            background-color: #000;
            margin-bottom: 10px;
            display: none;
        }
        
        .feedback {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        
        .feedback.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        
        .feedback.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .feedback.info {
            background-color: #d1ecf1;
            color: #0c5460;
            display: block;
        }
        
        .step-assistants {
            margin: 10px 0;
        }
        
        .assistant-tag {
            display: inline-block;
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .step-times {
            margin-top: 10px;
            font-size: 13px;
            color: #555;
        }
        
        .step-times div {
            margin-bottom: 3px;
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .process-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="../img/GZL - Logos_pages-to-jpg-0001.jpg" alt="Logo PA" class="sidebar-logo">
                <h2>Sistema PA</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="fas fa-home"></i> Início</a></li>
                <li class="active"><a href="shipment.html"><i class="fa fa-globe"></i> Shipment</a></li>
                <li><a href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="cadastro_colaborador.html"><i class="fas fa-users"></i> Cadastrar Funcionários</a></li>
                <li><a href="buscar_funcionarios.html"><i class="fas fa-search"></i> Buscar Funcionários</a></li>
                <li><a href="painel_de_controle.html"><i class="fa fa-tasks"></i> Painel De Controle</a></li>
                <li><a href="historico.html"><i class="fas fa-history"></i> Histórico</a></li>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <h1>Processo de Shipment</h1>
                <div class="user-info">
                    <span id="currentUser">Usuário Logado</span>
                </div>
            </header>

            <!-- Process Cards Container -->
            <div id="processCardsContainer" class="process-cards">
                <!-- Cards will be dynamically inserted here -->
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons" id="mainActionButtons">
                <button class="btn primary-btn" id="startShipmentProcessBtn">
                    <i class="fas fa-plus"></i> Novo Processo
                </button>
            </div>

            <!-- Modal Iniciar Processo -->
            <div class="modal" id="startProcessModal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2>Iniciar Novo Processo</h2>

                    <div id="startProcessFeedback" class="feedback"></div>

                    <div class="form-group">
                        <label for="dtNumber">Número da DT:</label>
                        <input type="text" id="dtNumber" placeholder="Digite o número da DT" required>
                    </div>

                    <div class="form-group">
                        <label for="vehicleType">Tipo de Veículo:</label>
                        <select id="vehicleType" required>
                            <option value="">Selecione...</option>
                            <option value="carregamento">Carregamento</option>
                            <option value="cliente_retira">Cliente Retira</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="dockNumber">Número da Doca:</label>
                        <select id="dockNumber" required>
                            <option value="">Selecione...</option>
                            <option value="1">Doca 1</option>
                            <option value="2">Doca 2</option>
                            <option value="3">Doca 3</option>
                            <option value="4">Doca 4</option>
                            <option value="5">Doca 5</option>
                            <option value="6">Doca 6</option>
                            <option value="7">Doca 7</option>
                            <option value="8">Doca 8</option>
                            <option value="9">Doca 9</option>
                            <option value="10">Doca 10</option>
                            <option value="11">Doca 11</option>
                            <option value="12">Doca 12</option>
                            <option value="13">Doca 13</option>
                            <option value="14">Doca 14</option>
                            <option value="15">Doca 15</option>
                        </select>
                    </div>

                    <div class="modal-actions">
                        <button class="btn secondary-btn" id="cancelStartProcessBtn">Cancelar</button>
                        <button class="btn primary-btn" id="confirmStartProcessBtn">Iniciar Processo</button>
                    </div>
                </div>
            </div>

            <!-- Modal QR Code Genérico -->
            <div class="modal" id="qrCodeModal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2 id="qrCodeModalTitle">Ler QR Code</h2>

                    <div id="qrCodeFeedback" class="feedback"></div>

                    <div class="qr-scanner-container">
                        <video id="qrCodeScanner" width="100%" playsinline></video>
                        <button class="btn primary-btn" id="startQrCodeScannerBtn">
                            <i class="fas fa-qrcode"></i> Ativar Leitor QR Code
                        </button>
                    </div>

                    <div id="qrCodeOperatorInfo" style="display: none; margin: 10px 0;">
                        Operador: <strong id="qrCodeOperatorName"></strong>
                    </div>

                    <div class="modal-actions">
                        <button class="btn secondary-btn" id="cancelQrCodeBtn">Cancelar</button>
                        <button class="btn primary-btn" id="confirmQrCodeBtn" disabled>Confirmar</button>
                    </div>
                </div>
            </div>

            <!-- Modal Múltiplos Ajudantes -->
            <div class="modal" id="assistantsModal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2 id="assistantsModalTitle">Registrar Ajudantes</h2>

                    <div id="assistantsFeedback" class="feedback"></div>

                    <div class="qr-scanner-container">
                        <video id="assistantsScanner" width="100%" playsinline></video>
                        <button class="btn primary-btn" id="startAssistantsScannerBtn">
                            <i class="fas fa-qrcode"></i> Adicionar Ajudante
                        </button>
                    </div>

                    <div class="step-assistants" id="assistantsList">
                        <!-- Ajudantes serão listados aqui -->
                    </div>

                    <div class="modal-actions">
                        <button class="btn secondary-btn" id="cancelAssistantsBtn">Cancelar</button>
                        <button class="btn primary-btn" id="confirmAssistantsBtn">Confirmar</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    
   <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAROtfqwCp2i2DVqqQDge6QueiNbmlPzuI",
            authDomain: "produtividade-pa.firebaseapp.com",
            projectId: "produtividade-pa",
            storageBucket: "produtividade-pa.firebasestorage.app",
            messagingSenderId: "455228218660",
            appId: "1:455228218660:web:f48ae8a0a03ea1062ca7b1",
            measurementId: "G-3ER0DB83JV"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Variáveis globais
        let currentUser = null;
        let currentScanner = null;
        let processes = {};
        let timers = {};
        let currentAssistants = [];

        // Elementos da página
        const elements = {
            startShipmentProcessBtn: document.getElementById('startShipmentProcessBtn'),
            currentUser: document.getElementById('currentUser'),
            mainActionButtons: document.getElementById('mainActionButtons'),
            processCardsContainer: document.getElementById('processCardsContainer'),
            
            // Modals
            startProcessModal: document.getElementById('startProcessModal'),
            qrCodeModal: document.getElementById('qrCodeModal'),
            assistantsModal: document.getElementById('assistantsModal'),
            
            // Start Process Modal
            dtNumber: document.getElementById('dtNumber'),
            vehicleType: document.getElementById('vehicleType'),
            dockNumber: document.getElementById('dockNumber'),
            confirmStartProcessBtn: document.getElementById('confirmStartProcessBtn'),
            cancelStartProcessBtn: document.getElementById('cancelStartProcessBtn'),
            startProcessFeedback: document.getElementById('startProcessFeedback'),
            
            // QR Code Modal
            qrCodeModalTitle: document.getElementById('qrCodeModalTitle'),
            qrCodeScanner: document.getElementById('qrCodeScanner'),
            startQrCodeScannerBtn: document.getElementById('startQrCodeScannerBtn'),
            qrCodeOperatorName: document.getElementById('qrCodeOperatorName'),
            qrCodeOperatorInfo: document.getElementById('qrCodeOperatorInfo'),
            confirmQrCodeBtn: document.getElementById('confirmQrCodeBtn'),
            cancelQrCodeBtn: document.getElementById('cancelQrCodeBtn'),
            qrCodeFeedback: document.getElementById('qrCodeFeedback'),
            
            // Assistants Modal
            assistantsModalTitle: document.getElementById('assistantsModalTitle'),
            assistantsScanner: document.getElementById('assistantsScanner'),
            startAssistantsScannerBtn: document.getElementById('startAssistantsScannerBtn'),
            assistantsList: document.getElementById('assistantsList'),
            confirmAssistantsBtn: document.getElementById('confirmAssistantsBtn'),
            cancelAssistantsBtn: document.getElementById('cancelAssistantsBtn'),
            assistantsFeedback: document.getElementById('assistantsFeedback'),
            
            // Others
            logoutBtn: document.getElementById('logoutBtn')
        };

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', () => {
            firebase.auth().onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = 'index.html';
                } else {
                    currentUser = user;
                    elements.currentUser.textContent = user.displayName || user.email;
                    setupEventListeners();
                    loadActiveProcesses();
                }
            });
        });

        function setupEventListeners() {
            elements.startShipmentProcessBtn.addEventListener('click', () => {
                elements.startProcessModal.style.display = 'flex';
            });
            
            elements.cancelStartProcessBtn.addEventListener('click', () => {
                elements.startProcessModal.style.display = 'none';
            });
            elements.confirmStartProcessBtn.addEventListener('click', startNewProcess);
            
            elements.startQrCodeScannerBtn.addEventListener('click', () => startScanner('generic'));
            elements.cancelQrCodeBtn.addEventListener('click', () => {
                elements.qrCodeModal.style.display = 'none';
                stopScanner();
            });
            elements.confirmQrCodeBtn.addEventListener('click', confirmCurrentStep);
            
            elements.startAssistantsScannerBtn.addEventListener('click', () => startScanner('assistants'));
            elements.cancelAssistantsBtn.addEventListener('click', () => {
                elements.assistantsModal.style.display = 'none';
                stopScanner();
                currentAssistants = [];
            });
            elements.confirmAssistantsBtn.addEventListener('click', confirmAssistants);
            
            elements.logoutBtn.addEventListener('click', () => {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                });
            });
            
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                    stopScanner();
                    currentAssistants = [];
                });
            });
        }

        function loadActiveProcesses() {
            db.ref('processos').orderByChild('createdBy').equalTo(currentUser.uid).on('value', snapshot => {
                processes = {};
                if (snapshot.exists()) {
                    snapshot.forEach(processSnapshot => {
                        const processData = processSnapshot.val();
                        if (processData.status !== 'completed') {
                            processes[processSnapshot.key] = {
                                ...processData,
                                id: processSnapshot.key
                            };
                            
                            if (!timers[processSnapshot.key] && processData.status === 'in_progress') {
                                startProcessTimer(processSnapshot.key, processData.startTime || Date.now());
                            }
                        }
                    });
                }
                renderProcessCards();
            });
        }

        function renderProcessCards() {
            elements.processCardsContainer.innerHTML = '';
            
            if (Object.keys(processes).length === 0) {
                showNoProcessesMessage();
                return;
            }
            
            Object.values(processes).forEach(process => {
                const card = createProcessCard(process);
                elements.processCardsContainer.appendChild(card);
            });
        }

        function createProcessCard(process) {
            const card = document.createElement('div');
            card.className = 'process-card';
            card.dataset.processId = process.id;
            
            const header = document.createElement('div');
            header.className = 'process-card-header';
            
            const title = document.createElement('h3');
            title.className = 'process-card-title';
            title.textContent = `DT: ${process.dtNumber}`;
            
            const status = document.createElement('span');
            status.className = `process-card-status ${process.status}`;
            status.textContent = getStatusLabel(process.status);
            
            header.appendChild(title);
            header.appendChild(status);
            
            const body = document.createElement('div');
            body.className = 'process-card-body';
            
            const vehicleInfo = document.createElement('div');
            vehicleInfo.className = 'process-card-info';
            vehicleInfo.textContent = `Tipo: ${process.vehicleType === 'cliente_retira' ? 'Cliente Retira' : 'Carregamento'}`;
            
            const dockInfo = document.createElement('div');
            dockInfo.className = 'process-card-info';
            dockInfo.textContent = `Doca: ${process.dockNumber}`;
            
            const timer = document.createElement('div');
            timer.className = 'timer-display';
            timer.innerHTML = `Tempo: <span id="timer-${process.id}">00:00:00</span>`;
            
            const currentStep = document.createElement('div');
            currentStep.className = 'step-title';
            currentStep.textContent = process.currentStep ? 
                getStepName(process.currentStep) : 'Processo concluído';
            
            const actions = document.createElement('div');
            actions.className = 'process-card-actions';
            
            if (process.status !== 'completed') {
                addStepButtons(actions, process);
            }
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn danger-btn';
            cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancelar';
            cancelBtn.addEventListener('click', () => cancelProcess(process.id));
            actions.appendChild(cancelBtn);
            
            body.appendChild(vehicleInfo);
            body.appendChild(dockInfo);
            body.appendChild(timer);
            body.appendChild(currentStep);
            body.appendChild(actions);
            
            card.appendChild(header);
            card.appendChild(body);
            
            return card;
        }

        function addStepButtons(container, process) {
            const stepsOrder = getStepsOrder(process.vehicleType);
            const currentStepIndex = process.currentStep ? stepsOrder.indexOf(process.currentStep) : -1;
            
            if (currentStepIndex === -1) {
                const startBtn = document.createElement('button');
                startBtn.className = 'btn primary-btn';
                startBtn.innerHTML = '<i class="fas fa-play"></i> Iniciar Vistoria';
                startBtn.addEventListener('click', () => showQrCodeModal('Iniciar Vistoria', 'start', process.id, 'vistoria'));
                container.appendChild(startBtn);
            } else {
                const currentStep = stepsOrder[currentStepIndex];
                const stepData = process[currentStep];
                
                if (stepData && stepData.status === 'in_progress') {
                    const endBtn = document.createElement('button');
                    endBtn.className = 'btn primary-btn';
                    endBtn.innerHTML = '<i class="fas fa-stop"></i> Finalizar Etapa';
                    
                    if (currentStep === 'abertura' || currentStep === 'fechamento') {
                        endBtn.addEventListener('click', () => showQrCodeModal(`Finalizar ${getStepName(currentStep)}`, 'complete', process.id, currentStep, true));
                    } else {
                        endBtn.addEventListener('click', () => showQrCodeModal(`Finalizar ${getStepName(currentStep)}`, 'complete', process.id, currentStep));
                    }
                    
                    container.appendChild(endBtn);
                    
                    if (currentStep === 'abertura' || currentStep === 'fechamento') {
                        const addBtn = document.createElement('button');
                        addBtn.className = 'btn secondary-btn';
                        addBtn.innerHTML = '<i class="fas fa-user-plus"></i> Adicionar Ajudantes';
                        addBtn.addEventListener('click', () => showAssistantsModal(process.id, currentStep));
                        container.appendChild(addBtn);
                    }
                } else {
                    const startBtn = document.createElement('button');
                    startBtn.className = 'btn primary-btn';
                    startBtn.innerHTML = '<i class="fas fa-play"></i> Iniciar Etapa';
                    
                    if (currentStep === 'abertura' || currentStep === 'fechamento') {
                        startBtn.addEventListener('click', () => showAssistantsModal(process.id, currentStep, true));
                    } else {
                        startBtn.addEventListener('click', () => showQrCodeModal(`Iniciar ${getStepName(currentStep)}`, 'start', process.id, currentStep));
                    }
                    
                    container.appendChild(startBtn);
                }
            }
        }

        function showNoProcessesMessage() {
            const message = document.createElement('div');
            message.className = 'feedback info';
            message.textContent = 'Nenhum processo ativo encontrado. Clique em "Novo Processo" para começar.';
            elements.processCardsContainer.appendChild(message);
        }

        function startProcessTimer(processId, startTime) {
            if (timers[processId]) clearInterval(timers[processId]);
            
            const updateTimer = () => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const timerElement = document.getElementById(`timer-${processId}`);
                if (timerElement) {
                    timerElement.textContent = formatTime(elapsed);
                }
            };
            
            updateTimer();
            timers[processId] = setInterval(updateTimer, 1000);
        }

        function showQrCodeModal(title, action, processId, step, isFinalStep = false) {
            elements.qrCodeModalTitle.textContent = title;
            elements.qrCodeModal.dataset.action = action;
            elements.qrCodeModal.dataset.processId = processId;
            elements.qrCodeModal.dataset.step = step;
            elements.qrCodeModal.dataset.isFinalStep = isFinalStep;
            
            elements.qrCodeOperatorName.textContent = '';
            elements.qrCodeOperatorInfo.style.display = 'none';
            elements.confirmQrCodeBtn.disabled = true;
            elements.qrCodeFeedback.style.display = 'none';
            
            elements.qrCodeModal.style.display = 'flex';
        }

        function showAssistantsModal(processId, step, isInitialStep = false) {
            elements.assistantsModalTitle.textContent = `Ajudantes para ${getStepName(step)}`;
            elements.assistantsModal.dataset.processId = processId;
            elements.assistantsModal.dataset.step = step;
            elements.assistantsModal.dataset.isInitialStep = isInitialStep;
            
            elements.assistantsList.innerHTML = '';
            elements.assistantsFeedback.style.display = 'none';
            currentAssistants = [];
            
            elements.assistantsModal.style.display = 'flex';
        }

        function startScanner(type) {
            stopScanner();
            
            let scannerElement = type === 'assistants' ? elements.assistantsScanner : elements.qrCodeScanner;
            scannerElement.style.display = 'block';
            
            currentScanner = new Instascan.Scanner({
                video: scannerElement,
                mirror: false
            });
            
            currentScanner.addListener('scan', content => handleQrScan(content, type));
            
            Instascan.Camera.getCameras()
                .then(cameras => {
                    if (cameras.length === 0) throw new Error('Nenhuma câmera encontrada');
                    const rearCamera = cameras.find(c => c.name.includes('traseira')) || 
                                     cameras.find(c => c.facing === 'environment') || 
                                     cameras[cameras.length - 1];
                    return currentScanner.start(rearCamera);
                })
                .catch(error => {
                    console.error('Erro ao iniciar scanner:', error);
                    showFeedback('Erro ao acessar câmera: ' + error.message, 'error', 
                               type === 'assistants' ? 'assistantsFeedback' : 'qrCodeFeedback');
                });
        }

        function stopScanner() {
            if (currentScanner) {
                currentScanner.stop();
                currentScanner = null;
            }
            elements.qrCodeScanner.style.display = 'none';
            elements.assistantsScanner.style.display = 'none';
        }

        function handleQrScan(content, type) {
            const qrCodeRegex = /^GZL-EO-\d{5}$/;
            if (!qrCodeRegex.test(content)) {
                showFeedback('QR Code inválido! Formato deve ser GZL-EO-XXXXX', 'error', 
                           type === 'assistants' ? 'assistantsFeedback' : 'qrCodeFeedback');
                return;
            }

            showFeedback('Validando QR Code...', 'info', 
                       type === 'assistants' ? 'assistantsFeedback' : 'qrCodeFeedback');

            db.ref('funcionarios').orderByChild('codigo').equalTo(content).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) throw new Error('Funcionário não encontrado');

                    let employeeData = null;
                    snapshot.forEach(child => {
                        employeeData = child.val();
                        return true;
                    });

                    if (type === 'assistants') {
                        if (!currentAssistants.some(a => a.code === content)) {
                            currentAssistants.push({
                                code: content,
                                name: employeeData.nome
                            });
                            updateAssistantsList();
                            showFeedback('Ajudante adicionado com sucesso!', 'success', 'assistantsFeedback');
                        } else {
                            showFeedback('Este ajudante já foi adicionado', 'warning', 'assistantsFeedback');
                        }
                    } else {
                        elements.qrCodeOperatorName.textContent = employeeData.nome;
                        elements.qrCodeOperatorInfo.style.display = 'block';
                        elements.confirmQrCodeBtn.disabled = false;
                        showFeedback('Operador validado com sucesso!', 'success', 'qrCodeFeedback');
                        stopScanner();
                    }
                })
                .catch(error => {
                    console.error('Erro ao validar QR Code:', error);
                    showFeedback('Erro: ' + error.message, 'error', 
                               type === 'assistants' ? 'assistantsFeedback' : 'qrCodeFeedback');
                });
        }

        function updateAssistantsList() {
            elements.assistantsList.innerHTML = '';
            currentAssistants.forEach(assistant => {
                const tag = document.createElement('span');
                tag.className = 'assistant-tag';
                tag.textContent = assistant.name;
                elements.assistantsList.appendChild(tag);
            });
        }

        function startNewProcess() {
            const dtNumber = elements.dtNumber.value.trim();
            const vehicleType = elements.vehicleType.value;
            const dockNumber = elements.dockNumber.value;

            if (!dtNumber || !vehicleType || !dockNumber) {
                showFeedback('Preencha todos os campos obrigatórios', 'error', 'startProcessFeedback');
                return;
            }

            db.ref('processos').orderByChild('dtNumber').equalTo(dtNumber).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) throw new Error('Já existe um processo com este número de DT');

                    const newProcess = {
                        dtNumber,
                        vehicleType,
                        dockNumber,
                        status: 'pending',
                        createdBy: currentUser.uid,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        currentStep: null
                    };

                    getStepsOrder(vehicleType).forEach(step => {
                        newProcess[step] = { status: 'pending' };
                    });

                    const processRef = db.ref('processos').push();
                    return processRef.set(newProcess)
                        .then(() => {
                            showFeedback('Processo criado com sucesso!', 'success', 'startProcessFeedback');
                            setTimeout(() => {
                                elements.startProcessModal.style.display = 'none';
                                elements.dtNumber.value = '';
                                elements.vehicleType.value = '';
                                elements.dockNumber.value = '';
                            }, 1500);
                        });
                })
                .catch(error => {
                    console.error('Erro ao iniciar processo:', error);
                    showFeedback('Erro: ' + error.message, 'error', 'startProcessFeedback');
                });
        }

        function confirmCurrentStep() {
            const action = elements.qrCodeModal.dataset.action;
            const processId = elements.qrCodeModal.dataset.processId;
            const step = elements.qrCodeModal.dataset.step;
            const isFinalStep = elements.qrCodeModal.dataset.isFinalStep === 'true';
            const operatorName = elements.qrCodeOperatorName.textContent;
            
            if (!operatorName || !processes[processId]) {
                showFeedback(operatorName ? 'Processo não encontrado' : 'Escaneie o QR Code do operador', 
                        'error', 'qrCodeFeedback');
                return;
            }
            
            elements.confirmQrCodeBtn.disabled = true;
            const processRef = db.ref(`processos/${processId}`);
            const process = processes[processId];
            const stepsOrder = getStepsOrder(process.vehicleType);
            const now = firebase.database.ServerValue.TIMESTAMP;
            
            const updates = {};
            
            if (action === 'start') {
                updates[`${step}/status`] = 'in_progress';
                updates[`${step}/startTime`] = now;
                updates[`${step}/operator`] = operatorName;
                updates.currentStep = step;
                updates.status = 'in_progress';
                
                if (!process.startTime) updates.startTime = now;
                
                const currentIndex = stepsOrder.indexOf(step);
                if (currentIndex > 0) {
                    const prevStep = stepsOrder[currentIndex - 1];
                    if (process[prevStep]?.endTime) {
                        updates[`${step}/waitTime`] = (Date.now() - process[prevStep].endTime) / 1000;
                    }
                }
            } else {
                updates[`${step}/status`] = 'completed';
                updates[`${step}/endTime`] = now;
                
                if (process[step]?.startTime) {
                    updates[`${step}/duration`] = (Date.now() - process[step].startTime) / 1000;
                }
                
                // Apenas marcar como completo quando for a última etapa
                const currentIndex = stepsOrder.indexOf(step);
                const nextStep = stepsOrder[currentIndex + 1];
                
                if (nextStep) {
                    updates[`${nextStep}/status`] = 'pending';
                    updates.currentStep = nextStep;
                } else {
                    // Última etapa concluída
                    updates.status = 'completed';
                    updates.endTime = now;
                }
            }
            
            processRef.update(updates)
                .then(() => {
                    showFeedback('Operação confirmada com sucesso!', 'success', 'qrCodeFeedback');
                    setTimeout(() => {
                        elements.qrCodeModal.style.display = 'none';
                        if (action === 'complete' && !updates.currentStep) {
                            saveProcessToHistory(processId);
                        }
                    }, 1500);
                })
                .catch(error => {
                    console.error('Erro ao confirmar etapa:', error);
                    showFeedback('Erro: ' + error.message, 'error', 'qrCodeFeedback');
                    elements.confirmQrCodeBtn.disabled = false;
                });
        }

        function getStepsOrder(vehicleType) {
            if (vehicleType === 'cliente_retira') {
                return ['vistoria', 'separacao'];
            } else if (vehicleType === 'carregamento') {
                return ['vistoria', 'abertura', 'separacao', 'faturamento', 'carregamento', 'fechamento'];
            }
            return [];
        }

        function confirmAssistants() {
            const processId = elements.assistantsModal.dataset.processId;
            const step = elements.assistantsModal.dataset.step;
            const isInitialStep = elements.assistantsModal.dataset.isInitialStep === 'true';
            
            if (currentAssistants.length === 0 || !processes[processId]) {
                showFeedback(currentAssistants.length === 0 ? 'Adicione pelo menos um ajudante' : 'Processo não encontrado', 
                           'error', 'assistantsFeedback');
                return;
            }
            
            const processRef = db.ref(`processos/${processId}`);
            const updates = {};
            const assistantsList = currentAssistants.map(a => ({ code: a.code, name: a.name }));
            const now = firebase.database.ServerValue.TIMESTAMP;
            
            if (isInitialStep) {
                updates[`${step}/status`] = 'in_progress';
                updates[`${step}/startTime`] = now;
                updates[`${step}/assistants`] = assistantsList;
                updates.currentStep = step;
                updates.status = 'in_progress';
                if (!processes[processId].startTime) updates.startTime = now;
            } else {
                updates[`${step}/assistants`] = firebase.database.ServerValue.increment(assistantsList);
            }
            
            processRef.update(updates)
                .then(() => {
                    showFeedback('Ajudantes registrados com sucesso!', 'success', 'assistantsFeedback');
                    setTimeout(() => {
                        elements.assistantsModal.style.display = 'none';
                        currentAssistants = [];
                    }, 1500);
                })
                .catch(error => {
                    console.error('Erro ao registrar ajudantes:', error);
                    showFeedback('Erro: ' + error.message, 'error', 'assistantsFeedback');
                });
        }

        function saveProcessToHistory(processId) {
            if (!processes[processId]) return;
            
            const process = processes[processId];
            const historyData = {
                processId: process.id,
                dtNumber: process.dtNumber,
                vehicleType: process.vehicleType,
                dockNumber: process.dockNumber,
                startTime: process.startTime,
                endTime: process.endTime || firebase.database.ServerValue.TIMESTAMP,
                createdBy: process.createdBy,
                steps: {},
                totalDuration: (process.endTime || Date.now()) - process.startTime
            };
            
            getStepsOrder(process.vehicleType).forEach(step => {
                if (process[step]) {
                    historyData.steps[step] = {
                        name: getStepName(step),
                        status: process[step].status,
                        startTime: process[step].startTime,
                        endTime: process[step].endTime,
                        duration: process[step].duration,
                        waitTime: process[step].waitTime,
                        operator: process[step].operator,
                        assistants: process[step].assistants
                    };
                }
            });
            
            db.ref('historico_processos').push(historyData)
                .then(() => db.ref(`processos/${processId}`).remove());
        }

        function cancelProcess(processId) {
            if (confirm('Tem certeza que deseja cancelar este processo?')) {
                db.ref(`processos/${processId}`).remove()
                    .catch(error => {
                        console.error('Erro ao cancelar processo:', error);
                        showFeedback('Erro ao cancelar processo: ' + error.message, 'error', 'qrCodeFeedback');
                    });
            }
        }

        function viewProcessDetails(processId) {
            alert(`Visualizar detalhes do processo ${processId}`);
        }

        // Funções auxiliares
        function getStepName(stepId) {
            const stepNames = {
                'vistoria': 'Vistoria',
                'abertura': 'Abertura do Caminhão',
                'separacao': 'Separação',
                'faturamento': 'Faturamento',
                'carregamento': 'Carregamento',
                'fechamento': 'Fechamento do Caminhão'
            };
            return stepNames[stepId] || stepId;
        }

        function getStepsOrder(vehicleType) {
            if (vehicleType === 'cliente_retira') {
                return ['vistoria', 'separacao'];
            } else if (vehicleType === 'carregamento') {
                return ['vistoria', 'abertura', 'separacao', 'faturamento', 'carregamento', 'fechamento'];
            }
            return [];
        }

        function showFeedback(message, type, elementId) {
            const feedbackElement = document.getElementById(elementId);
            if (!feedbackElement) return;

            feedbackElement.textContent = message;
            feedbackElement.style.display = 'block';
            feedbackElement.className = `feedback ${type}`;
            
            if (type !== 'info') {
                setTimeout(() => feedbackElement.style.display = 'none', 5000);
            }
        }

        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pendente',
                'in_progress': 'Em Andamento',
                'completed': 'Concluído'
            };
            return labels[status] || status;
        }
    </script>
</body>
</html>